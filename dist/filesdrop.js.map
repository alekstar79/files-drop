{"version":3,"file":"filesdrop.js","sources":["../lib/filesdrop.ts"],"sourcesContent":["type FileDropAccept = 'drop' | 'paste' | 'click'\n\ninterface FileDropEventInit extends EventInit {\n  action: FileDropAccept;\n  files: File[];\n}\n\nfunction getMatchingItems(\n  list: DataTransferItemList,\n  acceptVal: string,\n  multiple: boolean\n): DataTransferItem[] {\n  const dataItems = Array.from(list)\n  let results: DataTransferItem[]\n\n  // Return the first item (or undefined) if our filter is for all files\n  if (acceptVal === '') {\n    results = dataItems.filter(item => item.kind === 'file')\n    return (multiple) ? results : [results[0]]\n  }\n\n  // Split accepts values by ',' then by '/'. Trim everything & lowercase.\n  const accepts = acceptVal.toLowerCase().split(',').map((accept) => {\n    return accept.split('/').map(part => part.trim())\n  }).filter(acceptParts => acceptParts.length === 2)\n\n  const predicate = (item: DataTransferItem) => {\n    if (item.kind !== 'file') return false\n\n    // Parse the type.\n    const [typeMain, typeSub] = item.type.toLowerCase().split('/').map(s => s.trim())\n\n    for (const [acceptMain, acceptSub] of accepts) {\n      // Look for an exact match, or a partial match if * is accepted, eg image/*.\n      if (typeMain === acceptMain && (acceptSub === '*' || typeSub === acceptSub)) {\n        return true\n      }\n    }\n\n    return false\n  }\n\n  results = dataItems.filter(predicate)\n  if (!multiple) {\n    results = [results[0]]\n  }\n\n  return results\n}\n\nfunction getFileData(data: DataTransfer, accept: string, multiple: boolean): File[]\n{\n  const dragDataItems = getMatchingItems(data.items, accept, multiple)\n  const files: File[] = []\n\n  // This is because Map doesn't like the null type returned by getAsFile\n  dragDataItems.forEach((item) => {\n    const file = item.getAsFile()\n    if (file === null) return\n    files.push(file)\n  })\n\n  return files\n}\n\n// Safari and Edge don't quite support extending Event, this works around it.\nfunction fixExtendedEvent(instance: Event, type: Function): void\n{\n  if (!(instance instanceof type)) {\n    Object.setPrototypeOf(instance, type.prototype)\n  }\n}\n\nfunction hide(el: HTMLElement): void\n{\n  Object.assign(el.style, { visibility: 'hidden', position: 'fixed', left: '-9999px', top: '-9999px' })\n}\n\nfunction clickEvent(): MouseEvent\n{\n  return new MouseEvent('click', { cancelable: true, bubbles: true, view: window })\n}\n\nexport class FileDropEvent extends Event\n{\n  private _action: FileDropAccept\n  private _files: File[]\n  constructor(typeArg: string, eventInitDict: FileDropEventInit)\n  {\n    super(typeArg, eventInitDict)\n\n    fixExtendedEvent(this, FileDropEvent)\n    this._action = eventInitDict.action\n    this._files = eventInitDict.files\n  }\n\n  get action() {\n    return this._action\n  }\n\n  get files() {\n    return this._files\n  }\n}\n\nexport class FilesDropElement extends HTMLElement\n{\n  static register(tag = 'file-drop') {\n    if ('customElements' in window) {\n      customElements.define(tag, this)\n    }\n  }\n\n  private _dragEnterCount = 0\n\n  constructor()\n  {\n    super()\n\n    this._onDragEnter = this._onDragEnter.bind(this)\n    this._onDragLeave = this._onDragLeave.bind(this)\n    this._onDrop = this._onDrop.bind(this)\n    this._onPaste = this._onPaste.bind(this)\n    this._onClick = this._onClick.bind(this)\n  }\n\n  get accept() {\n    return this.getAttribute('accept') || ''\n  }\n\n  set accept(val: string) {\n    this.setAttribute('accept', val)\n  }\n\n  get multiple(): boolean {\n    return this.hasAttribute('multiple')\n  }\n\n  get clickable(): boolean {\n    return this.hasAttribute('clickable')\n  }\n\n  connectedCallback()\n  {\n    this.addEventListener('dragover', event => event.preventDefault())\n    this.addEventListener('drop', this._onDrop)\n    this.addEventListener('dragenter', this._onDragEnter)\n    this.addEventListener('dragend', () => this._reset())\n    this.addEventListener('dragleave', this._onDragLeave)\n    this.addEventListener('paste', this._onPaste)\n\n    if (this.clickable) {\n      this.addEventListener('click', this._onClick)\n    }\n  }\n\n  disconnectedCallback()\n  {\n    this.removeEventListener('dragover', event => event.preventDefault())\n    this.removeEventListener('drop', this._onDrop)\n    this.removeEventListener('dragenter', this._onDragEnter)\n    this.removeEventListener('dragend', () => this._reset())\n    this.removeEventListener('dragleave', this._onDragLeave)\n    this.removeEventListener('paste', this._onPaste)\n\n    if (this.clickable) {\n      this.removeEventListener('click', this._onClick)\n    }\n  }\n\n  private _onDragEnter(event: DragEvent)\n  {\n    this._dragEnterCount += 1\n\n    if (this._dragEnterCount > 1) return\n    if (event.dataTransfer === null) {\n      this.classList.add('drop-invalid')\n      return\n    }\n\n    // We don't have data, attempt to get it and if it matches, set the correct state.\n    const items = event.dataTransfer.items\n    const matchingFiles = getMatchingItems(items, this.accept, this.multiple)\n    const validDrop: boolean = event.dataTransfer && event.dataTransfer.items.length\n      ? (matchingFiles[0] !== undefined)\n      // Safari doesn't give file information on drag enter,\n      // so the best we can do is return valid.\n      : true\n\n    if (validDrop) {\n      this.classList.add('drop-valid')\n    } else {\n      this.classList.add('drop-invalid')\n    }\n  }\n\n  private _onDragLeave()\n  {\n    this._dragEnterCount -= 1\n\n    if (this._dragEnterCount === 0) {\n      this._reset()\n    }\n  }\n\n  private _onDrop(event: DragEvent)\n  {\n    event.preventDefault()\n\n    if (event.dataTransfer === null) return\n\n    this._reset()\n    const action = 'drop'\n    const files = getFileData(event.dataTransfer, this.accept, this.multiple)\n\n    if (files === undefined) return\n\n    this.dispatchEvent(new FileDropEvent('filedrop', { action, files }))\n  }\n\n  private _onPaste(event: ClipboardEvent)\n  {\n    const action = 'paste'\n\n    if (!event.clipboardData) return\n    const files = getFileData(event.clipboardData, this.accept, this.multiple)\n    if (files === undefined) return\n\n    this.dispatchEvent(new FileDropEvent('filedrop', { action, files }))\n  }\n\n  private _reset()\n  {\n    this._dragEnterCount = 0\n    this.classList.remove('drop-valid')\n    this.classList.remove('drop-invalid')\n  }\n\n  _onClick(): Promise<File[] | []>\n  {\n    return new Promise(() => {\n      const input = document.createElement('input')\n      const click = clickEvent()\n\n      input.multiple = this.multiple\n      input.accept = this.accept\n      input.type = 'file'\n\n      hide(input)\n\n      input.addEventListener('change', (inputEvent: Event) => {\n        const target = inputEvent.target as HTMLInputElement\n        const action = 'click'\n\n        const accept = this.accept.split('/')[0]\n        const files = Array.from(target.files as FileList)\n          .filter(file => file.type.split('/')[0] === accept)\n\n        this.dispatchEvent(new FileDropEvent('filedrop', { action, files }))\n\n        input.parentNode?.removeChild(input)\n      })\n\n      document.body.appendChild(input)\n      input.dispatchEvent(click)\n    })\n  }\n}\n\nFilesDropElement.register()\n\ndeclare global {\n  interface HTMLElementEventMap {\n    filedrop: FileDropEvent\n  }\n}\n"],"names":["getMatchingItems","list","acceptVal","multiple","results","dataItems","Array","from","filter","item","kind","accepts","toLowerCase","split","map","accept","part","trim","acceptParts","length","_step","_item$type$toLowerCas","type","s","typeMain","typeSub","_iterator","_createForOfIteratorHelperLoose","done","_step$value","value","acceptSub","getFileData","data","dragDataItems","items","files","forEach","file","getAsFile","push","FileDropEvent","_Event","typeArg","eventInitDict","_this","instance","call","this","_action","_files","fixExtendedEvent","Object","setPrototypeOf","prototype","action","_createClass","_inheritsLoose","key","get","_wrapNativeSuper","Event","FilesDropElement","_HTMLElement","_this2","_dragEnterCount","_onDragEnter","bind","_onDragLeave","_onDrop","_onPaste","_onClick","register","tag","window","customElements","define","_proto","connectedCallback","_this3","addEventListener","event","preventDefault","_reset","clickable","disconnectedCallback","_this4","removeEventListener","dataTransfer","matchingFiles","classList","add","undefined","dispatchEvent","clipboardData","remove","_this5","Promise","input","document","createElement","click","MouseEvent","cancelable","bubbles","view","assign","style","visibility","position","left","top","inputEvent","_input$parentNode","target","parentNode","removeChild","body","appendChild","getAttribute","set","val","setAttribute","hasAttribute","HTMLElement"],"mappings":"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"}